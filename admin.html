<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex, nofollow" />
  <meta name="googlebot" content="noindex, nofollow" />
  <title>Form Submissions | Syntra Refining</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500;700&family=Oswald:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/syntra-brand-theme.css">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            syntra: {
              base: '#F8FAFC',
              surface: '#FFFFFF',
              text: '#0F172A',
              midnight: '#0B1120',
              accent: '#FFD700',
              amber: '#FFD700',
              tech: '#0891B2',
              muted: '#64748B',
              border: '#E2E8F0',
            }
          },
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
            head: ['Oswald', 'sans-serif'],
            mono: ['JetBrains Mono', 'monospace'],
          },
        }
      }
    }
  </script>

  <style>
    .logo-container { cursor: pointer; }
    .logo-container img { transition: transform 0.3s ease, filter 0.3s ease; }
    .logo-container:hover img { transform: scale(1.05); filter: brightness(1.1); }

    #loginScreen { display: flex; }
    #adminPanel { display: none; }
    .authenticated #loginScreen { display: none; }
    .authenticated #adminPanel { display: block; }
  </style>
</head>
<body class="bg-syntra-base text-syntra-text font-sans antialiased">

  <!-- LOGIN SCREEN -->
  <div id="loginScreen" class="min-h-screen items-center justify-center bg-gradient-to-br from-syntra-midnight via-slate-900 to-syntra-midnight">
    <div class="w-full max-w-md p-8">
      <div class="bg-white rounded-lg shadow-2xl p-8">
        <div class="text-center mb-8">
          <div class="logo-container inline-flex items-center gap-3 mb-4">
            <img
              src="/assets/images/syntra-logo-full.png"
              alt="Syntra Refining Corp."
              class="h-16 w-auto"
            >
          </div>
          <h1 class="font-head text-2xl font-bold uppercase mb-2">Admin Access</h1>
          <p class="text-sm text-syntra-muted">Enter your credentials to continue</p>
        </div>

        <form id="loginForm" class="space-y-4" onsubmit="handleLogin(event)">
          <div>
            <label for="username" class="block text-sm font-mono uppercase text-syntra-muted mb-2">Email Address</label>
            <input
              type="email"
              id="username"
              class="w-full px-4 py-3 border-2 border-syntra-border rounded-lg focus:border-syntra-accent focus:outline-none font-mono"
              placeholder="Enter your email"
              required
              autocomplete="email"
            />
          </div>

          <div>
            <label for="password" class="block text-sm font-mono uppercase text-syntra-muted mb-2">Password</label>
            <input
              type="password"
              id="password"
              class="w-full px-4 py-3 border-2 border-syntra-border rounded-lg focus:border-syntra-accent focus:outline-none font-mono"
              placeholder="Enter your password"
              required
              autocomplete="current-password"
            />
          </div>

          <div id="loginError" class="hidden bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-lg text-sm"></div>

          <button
            type="submit"
            class="w-full bg-syntra-text hover:bg-black text-white font-mono uppercase py-3 rounded-lg transition-colors text-center"
          >
            Login
          </button>
        </form>

        <div class="mt-6 pt-6 border-t border-syntra-border">
          <p class="text-xs text-syntra-muted text-center">
            Authorized access only. All activities are logged.
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- ADMIN PANEL -->
  <div id="adminPanel">
    <!-- NAV -->
    <nav class="bg-white border-b border-syntra-border">
      <div class="container mx-auto px-6 h-20 flex items-center justify-between">
        <a href="index.html" class="logo-container flex items-center gap-3 group">
          <img
            src="/assets/images/syntra-logo-full.png"
            alt="Syntra Refining Corp."
            class="h-12 w-auto"
          >
        </a>
        <div class="flex items-center gap-4">
          <div class="text-xs font-mono uppercase text-syntra-muted">Form Submissions</div>
          <button onclick="handleLogout()" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white text-xs font-mono uppercase rounded transition-colors">
            Logout
          </button>
        </div>
      </div>
    </nav>

    <!-- MAIN CONTENT -->
    <div class="container mx-auto px-6 py-12">
      <!-- Header with Stats -->
      <div class="mb-8">
        <h1 class="font-head text-4xl font-bold uppercase mb-4">Form Submissions</h1>
        <div class="grid md:grid-cols-4 gap-4">
          <div class="bg-white border border-syntra-border rounded-lg p-4">
            <p class="text-xs font-mono text-syntra-muted uppercase mb-1">Total</p>
            <p id="totalCount" class="font-head text-3xl font-bold">0</p>
          </div>
          <div class="bg-white border border-syntra-border rounded-lg p-4">
            <p class="text-xs font-mono text-syntra-muted uppercase mb-1">Unread</p>
            <p id="unreadCount" class="font-head text-3xl font-bold text-syntra-amber">0</p>
          </div>
          <div class="bg-white border border-syntra-border rounded-lg p-4">
            <p class="text-xs font-mono text-syntra-muted uppercase mb-1">Partner Inquiries</p>
            <p id="partnerCount" class="font-head text-3xl font-bold">0</p>
          </div>
          <div class="bg-white border border-syntra-border rounded-lg p-4">
            <p class="text-xs font-mono text-syntra-muted uppercase mb-1">Investor Inquiries</p>
            <p id="investorCount" class="font-head text-3xl font-bold">0</p>
          </div>
        </div>
      </div>

      <!-- Filters -->
      <div class="bg-white border border-syntra-border rounded-lg p-4 mb-6">
        <div class="flex flex-wrap gap-4 items-center">
          <label class="flex items-center gap-2">
            <span class="text-sm font-mono uppercase text-syntra-muted">Filter:</span>
          </label>
          <select id="filterType" class="bg-slate-50 border border-slate-200 rounded px-4 py-2 text-sm font-mono" onchange="loadSubmissions()">
            <option value="all">All Types</option>
            <option value="partner_inquiry">Partner Inquiries</option>
            <option value="investor_inquiry">Investor Inquiries</option>
            <option value="career_application">Career Applications</option>
          </select>
          <select id="filterStatus" class="bg-slate-50 border border-slate-200 rounded px-4 py-2 text-sm font-mono" onchange="loadSubmissions()">
            <option value="all">All Status</option>
            <option value="unread">Unread Only</option>
            <option value="read">Read Only</option>
          </select>
          <button onclick="loadSubmissions()" class="ml-auto px-4 py-2 bg-syntra-text text-white text-sm font-mono uppercase rounded hover:bg-black transition-colors">
            Refresh
          </button>
        </div>
      </div>

      <!-- Submissions List -->
      <div id="submissionsList" class="space-y-4">
        <div class="py-12 text-slate-500">
          <p class="font-mono text-sm">Loading submissions...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Microsoft Calendar Modal -->
  <div id="calendarModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="font-head text-xl font-bold uppercase">Add to Calendar</h3>
        <button onclick="closeCalendarModal()" class="text-syntra-muted hover:text-syntra-text">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <form id="calendarForm" onsubmit="addToCalendar(event)">
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-mono uppercase text-syntra-muted mb-2">Event Title</label>
            <input type="text" id="eventTitle" class="w-full px-4 py-2 border border-syntra-border rounded" required />
          </div>

          <div>
            <label class="block text-sm font-mono uppercase text-syntra-muted mb-2">Start Date & Time</label>
            <input type="datetime-local" id="eventStart" class="w-full px-4 py-2 border border-syntra-border rounded" required />
          </div>

          <div>
            <label class="block text-sm font-mono uppercase text-syntra-muted mb-2">End Date & Time</label>
            <input type="datetime-local" id="eventEnd" class="w-full px-4 py-2 border border-syntra-border rounded" required />
          </div>

          <div>
            <label class="block text-sm font-mono uppercase text-syntra-muted mb-2">Description</label>
            <textarea id="eventDescription" rows="3" class="w-full px-4 py-2 border border-syntra-border rounded"></textarea>
          </div>

          <input type="hidden" id="eventAttendee" />
        </div>

        <div class="mt-6 flex gap-3">
          <button type="button" onclick="closeCalendarModal()" class="flex-1 px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 font-mono uppercase rounded transition-colors">
            Cancel
          </button>
          <button type="submit" class="flex-1 px-4 py-2 bg-syntra-text hover:bg-black text-white font-mono uppercase rounded transition-colors">
            Add to Calendar
          </button>
        </div>
      </form>

      <div class="mt-4 p-3 bg-cyan-50 border border-cyan-200 rounded text-xs text-cyan-800">
        <p class="font-semibold mb-1">Microsoft 365/Outlook Integration</p>
        <p>This will generate a calendar event that you can add to Microsoft Outlook or Office 365.</p>
      </div>
    </div>
  </div>

  <!-- Supabase JS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/js/syntra-config.js?v=202"></script>
  <script src="/js/supabase-client.js?v=202"></script>

  <script>
    const SESSION_TIMEOUT = 30 * 60 * 1000;
    let currentSubmissionForCalendar = null;
    let sessionTimeoutId = null;
    let currentUser = null;

    async function checkAuth() {
      try {
        const { data: { session }, error } = await supabase.auth.getSession();

        if (error || !session) {
          return false;
        }

        const userRole = session.user?.app_metadata?.role;
        if (userRole !== 'admin') {
          console.error('User is not an admin');
          await supabase.auth.signOut();
          return false;
        }

        currentUser = session.user;
        document.body.classList.add('authenticated');
        startSessionTimeout();
        loadSubmissions();
        return true;
      } catch (error) {
        console.error('Auth check error:', error);
        return false;
      }
    }

    async function handleLogin(event) {
      event.preventDefault();
      const email = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const errorDiv = document.getElementById('loginError');
      const submitBtn = event.target.querySelector('button[type="submit"]');

      submitBtn.disabled = true;
      submitBtn.textContent = 'Logging in...';

      try {
        const { data, error } = await supabase.auth.signInWithPassword({
          email: email,
          password: password
        });

        if (error) throw error;

        const userRole = data.user?.app_metadata?.role;
        if (userRole !== 'admin') {
          await supabase.auth.signOut();
          throw new Error('Access denied. Admin privileges required.');
        }

        currentUser = data.user;
        document.body.classList.add('authenticated');
        errorDiv.classList.add('hidden');
        startSessionTimeout();
        loadSubmissions();

        await logAdminAction('LOGIN', 'admin_audit_log', null, {
          email: data.user.email,
          timestamp: new Date().toISOString()
        });

      } catch (error) {
        console.error('Login error:', error);
        errorDiv.textContent = error.message || 'Invalid email or password. Please try again.';
        errorDiv.classList.remove('hidden');
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
        document.getElementById('username').focus();
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Login';
      }
    }

    async function handleLogout() {
      if (confirm('Are you sure you want to logout?')) {
        try {
          await logAdminAction('LOGOUT', 'admin_audit_log', null, {
            email: currentUser?.email,
            timestamp: new Date().toISOString()
          });

          await supabase.auth.signOut();
          clearTimeout(sessionTimeoutId);
          currentUser = null;
          document.body.classList.remove('authenticated');
          document.getElementById('username').value = '';
          document.getElementById('password').value = '';
        } catch (error) {
          console.error('Logout error:', error);
        }
      }
    }

    function startSessionTimeout() {
      clearTimeout(sessionTimeoutId);
      sessionTimeoutId = setTimeout(async () => {
        alert('Your session has expired for security reasons. Please log in again.');
        await handleLogout();
      }, SESSION_TIMEOUT);
    }

    async function logAdminAction(action, tableName, recordId = null, details = {}) {
      try {
        await supabase.rpc('log_admin_action', {
          p_action: action,
          p_table_name: tableName,
          p_record_id: recordId,
          p_details: details
        });
      } catch (error) {
        console.warn('Failed to log admin action:', error);
      }
    }

    async function loadSubmissions() {
      const filterType = document.getElementById('filterType').value;
      const filterStatus = document.getElementById('filterStatus').value;

      try {
        startSessionTimeout();

        let query = supabase
          .from('form_submissions')
          .select('*')
          .order('created_at', { ascending: false });

        if (filterType !== 'all') {
          query = query.eq('form_type', filterType);
        }

        if (filterStatus === 'unread') {
          query = query.eq('read_status', false);
        } else if (filterStatus === 'read') {
          query = query.eq('read_status', true);
        }

        const { data, error } = await query;

        if (error) {
          if (error.message.includes('JWT') || error.code === 'PGRST301') {
            alert('Session expired. Please log in again.');
            await handleLogout();
            return;
          }
          throw error;
        }

        displaySubmissions(data);
        updateStats(data);
      } catch (error) {
        console.error('Error loading submissions:', error);
        document.getElementById('submissionsList').innerHTML = `
          <div class="bg-red-50 border border-red-200 rounded-lg p-6">
            <p class="text-red-600 font-bold mb-2">Error Loading Submissions</p>
            <p class="text-sm text-red-500">${error.message}</p>
          </div>
        `;
      }
    }

    function updateStats(data) {
      const total = data.length;
      const unread = data.filter(s => !s.read_status).length;
      const partner = data.filter(s => s.form_type === 'partner_inquiry').length;
      const investor = data.filter(s => s.form_type === 'investor_inquiry').length;

      document.getElementById('totalCount').textContent = total;
      document.getElementById('unreadCount').textContent = unread;
      document.getElementById('partnerCount').textContent = partner;
      document.getElementById('investorCount').textContent = investor;
    }

    function displaySubmissions(submissions) {
      const container = document.getElementById('submissionsList');

      if (submissions.length === 0) {
        container.innerHTML = `
          <div class="py-12 text-slate-500">
            <p class="font-mono text-sm">No submissions found.</p>
          </div>
        `;
        return;
      }

      container.innerHTML = submissions.map(sub => `
        <div class="bg-white border ${sub.read_status ? 'border-syntra-border' : 'border-syntra-accent border-2'} rounded-lg p-6 ${sub.read_status ? '' : 'bg-yellow-50/30'}">
          <div class="flex items-start justify-between mb-4">
            <div class="flex items-start gap-4 flex-1">
              ${sub.read_status ? '' : '<div class="w-2 h-2 bg-syntra-accent rounded-full mt-2"></div>'}
              <div class="flex-1">
                <div class="flex items-center gap-3 mb-2">
                  <h3 class="font-head text-xl font-bold uppercase">
                    ${sub.first_name} ${sub.last_name || ''}
                  </h3>
                  <span class="px-2 py-1 bg-slate-100 rounded text-xs font-mono uppercase">
                    ${sub.form_type === 'partner_inquiry' ? 'Partner' : sub.form_type === 'investor_inquiry' ? 'Investor' : 'Career Application'}
                  </span>
                  ${sub.reference_id ? `<span class="px-2 py-1 bg-cyan-100 text-cyan-800 rounded text-xs font-mono">${sub.reference_id}</span>` : ''}
                  ${sub.read_status ? '' : '<span class="px-2 py-1 bg-syntra-accent/20 text-syntra-amber rounded text-xs font-mono uppercase font-bold">NEW</span>'}
                </div>
                <div class="grid md:grid-cols-2 gap-x-6 gap-y-2 text-sm mb-3">
                  <div>
                    <span class="font-mono text-syntra-muted text-xs">Email:</span>
                    <a href="mailto:${sub.email}" class="text-syntra-tech hover:underline ml-2">${sub.email}</a>
                  </div>
                  ${sub.phone ? `
                  <div>
                    <span class="font-mono text-syntra-muted text-xs">Phone:</span>
                    <a href="tel:${sub.phone}" class="text-syntra-tech hover:underline ml-2">${sub.phone}</a>
                  </div>
                  ` : ''}
                  ${sub.form_type !== 'career_application' && sub.organization ? `
                  <div>
                    <span class="font-mono text-syntra-muted text-xs">Organization:</span>
                    <span class="ml-2 font-semibold">${sub.organization}</span>
                  </div>
                  ` : ''}
                  ${sub.interest_type ? `
                  <div>
                    <span class="font-mono text-syntra-muted text-xs">${sub.form_type === 'career_application' ? 'Position' : 'Interest'}:</span>
                    <span class="ml-2">${sub.interest_type}</span>
                  </div>
                  ` : ''}
                  <div>
                    <span class="font-mono text-syntra-muted text-xs">Date:</span>
                    <span class="ml-2">${new Date(sub.created_at).toLocaleString()}</span>
                  </div>
                  ${sub.additional_data?.linkedin ? `
                  <div>
                    <span class="font-mono text-syntra-muted text-xs">LinkedIn:</span>
                    <a href="${sub.additional_data.linkedin}" target="_blank" class="text-syntra-tech hover:underline ml-2">View Profile</a>
                  </div>
                  ` : ''}
                  ${sub.additional_data?.resume_url ? `
                  <div class="col-span-2">
                    <span class="font-mono text-syntra-muted text-xs">Resume:</span>
                    <div class="ml-2 inline-flex flex-col gap-1">
                      <a href="${sub.additional_data.resume_url}" target="_blank" class="text-syntra-tech hover:underline inline-flex items-center gap-1 font-semibold">
                        Download Resume
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                        </svg>
                      </a>
                      ${sub.additional_data?.resume_metadata ? `
                      <div class="text-[10px] font-mono text-slate-500 space-y-0.5">
                        <div><strong>File:</strong> ${sub.additional_data.resume_metadata.name || 'Unknown'}</div>
                        <div><strong>Size:</strong> ${(sub.additional_data.resume_metadata.size / 1024 / 1024).toFixed(2)} MB</div>
                        <div><strong>Type:</strong> ${sub.additional_data.resume_metadata.type === 'application/pdf' ? 'PDF' : sub.additional_data.resume_metadata.type === 'application/msword' ? 'DOC' : sub.additional_data.resume_metadata.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' ? 'DOCX' : sub.additional_data.resume_metadata.type || 'Unknown'}</div>
                      </div>
                      ` : ''}
                    </div>
                  </div>
                  ` : ''}
                </div>
                ${sub.message ? `
                  <div class="bg-slate-50 rounded p-3 text-sm">
                    <p class="font-mono text-syntra-muted text-xs mb-1">${sub.form_type === 'career_application' ? 'Cover Letter:' : 'Message:'}</p>
                    <p class="whitespace-pre-wrap">${sub.message}</p>
                  </div>
                ` : ''}
              </div>
            </div>
            <div class="flex flex-col gap-2 ml-4">
              <button onclick="sendEmailOutlook(${JSON.stringify(sub).replace(/"/g, '&quot;')})" class="px-3 py-2 bg-gradient-to-r from-cyan-600 to-cyan-700 text-white text-xs font-mono uppercase rounded-md hover:from-cyan-700 hover:to-cyan-800 transition-all duration-200 inline-flex items-center gap-2 shadow-sm hover:shadow-md hover:-translate-y-0.5">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                </svg>
                Outlook
              </button>
              <button onclick="openCalendarModal(${JSON.stringify(sub).replace(/"/g, '&quot;')})" class="px-3 py-2 bg-gradient-to-r from-slate-600 to-slate-700 text-white text-xs font-mono uppercase rounded-md hover:from-slate-700 hover:to-slate-800 transition-all duration-200 inline-flex items-center gap-2 shadow-sm hover:shadow-md hover:-translate-y-0.5">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                Calendar
              </button>
              ${sub.read_status
                ? `<button onclick="markAsUnread('${sub.id}')" class="px-3 py-2 bg-slate-200 text-slate-700 text-xs font-mono uppercase rounded-md hover:bg-slate-300 transition-all duration-200 shadow-sm hover:shadow-md hover:-translate-y-0.5">Mark Unread</button>`
                : `<button onclick="markAsRead('${sub.id}')" class="px-3 py-2 bg-gradient-to-r from-syntra-accent to-yellow-400 text-syntra-text text-xs font-mono uppercase rounded-md hover:from-yellow-400 hover:to-yellow-500 transition-all duration-200 shadow-md hover:shadow-lg hover:-translate-y-0.5 font-bold">Mark Read</button>`
              }
              <button onclick="deleteSubmission('${sub.id}')" class="px-3 py-2 bg-gradient-to-r from-red-600 to-red-700 text-white text-xs font-mono uppercase rounded-md hover:from-red-700 hover:to-red-800 transition-all duration-200 inline-flex items-center gap-2 shadow-sm hover:shadow-md hover:-translate-y-0.5">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
                Delete
              </button>
            </div>
          </div>
        </div>
      `).join('');
    }

    async function markAsRead(id) {
      try {
        startSessionTimeout();

        const { error } = await supabase
          .from('form_submissions')
          .update({ read_status: true })
          .eq('id', id);

        if (error) throw error;

        await logAdminAction('MARK_READ', 'form_submissions', id, {
          action: 'marked as read'
        });

        loadSubmissions();
      } catch (error) {
        console.error('Error updating submission:', error);
        alert('Failed to update submission status: ' + error.message);
      }
    }

    async function markAsUnread(id) {
      try {
        startSessionTimeout();

        const { error } = await supabase
          .from('form_submissions')
          .update({ read_status: false })
          .eq('id', id);

        if (error) throw error;

        await logAdminAction('MARK_UNREAD', 'form_submissions', id, {
          action: 'marked as unread'
        });

        loadSubmissions();
      } catch (error) {
        console.error('Error updating submission:', error);
        alert('Failed to update submission status: ' + error.message);
      }
    }

    async function deleteSubmission(id) {
      if (!confirm('Are you sure you want to delete this submission? This action cannot be undone.')) {
        return;
      }

      try {
        startSessionTimeout();

        const { data: submission } = await supabase
          .from('form_submissions')
          .select('reference_id, email, first_name, last_name')
          .eq('id', id)
          .maybeSingle();

        const { error } = await supabase
          .from('form_submissions')
          .delete()
          .eq('id', id);

        if (error) throw error;

        await logAdminAction('DELETE', 'form_submissions', id, {
          reference_id: submission?.reference_id,
          email: submission?.email,
          name: `${submission?.first_name} ${submission?.last_name || ''}`
        });

        loadSubmissions();

        const successMsg = document.createElement('div');
        successMsg.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 font-mono text-sm';
        successMsg.textContent = 'Submission deleted successfully';
        document.body.appendChild(successMsg);

        setTimeout(() => {
          successMsg.remove();
        }, 3000);
      } catch (error) {
        console.error('Error deleting submission:', error);
        alert('Failed to delete submission: ' + error.message);
      }
    }

    function openCalendarModal(submission) {
      currentSubmissionForCalendar = submission;

      const formType = submission.form_type === 'partner_inquiry' ? 'Partner' :
                      submission.form_type === 'investor_inquiry' ? 'Investor' : 'Career';

      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      tomorrow.setHours(10, 0, 0, 0);

      const endTime = new Date(tomorrow);
      endTime.setHours(11, 0, 0, 0);

      document.getElementById('eventTitle').value = `Follow-up: ${formType} - ${submission.first_name} ${submission.last_name || ''}`;
      document.getElementById('eventStart').value = formatDateTimeLocal(tomorrow);
      document.getElementById('eventEnd').value = formatDateTimeLocal(endTime);
      document.getElementById('eventDescription').value =
        `Follow-up meeting with ${submission.first_name} ${submission.last_name || ''}\n` +
        `Reference: ${submission.reference_id || 'N/A'}\n` +
        `Email: ${submission.email}\n` +
        `Phone: ${submission.phone || 'N/A'}\n` +
        `Organization: ${submission.organization || 'N/A'}\n\n` +
        `Original Message:\n${submission.message || 'No message provided'}`;

      document.getElementById('eventAttendee').value = submission.email;

      document.getElementById('calendarModal').classList.remove('hidden');
    }

    function closeCalendarModal() {
      document.getElementById('calendarModal').classList.add('hidden');
      currentSubmissionForCalendar = null;
    }

    function formatDateTimeLocal(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      return `${year}-${month}-${day}T${hours}:${minutes}`;
    }

    function sendEmailOutlook(submission) {
      const subject = encodeURIComponent(`Follow-up: ${submission.first_name} ${submission.last_name || ''} - ${submission.reference_id || ''}`);

      const formType = submission.form_type === 'partner_inquiry' ? 'Partner Inquiry' :
                      submission.form_type === 'investor_inquiry' ? 'Investor Inquiry' : 'Career Application';

      const bodyLines = [
        `Dear ${submission.first_name},`,
        '',
        `Thank you for your interest in Syntra Refining.`,
        '',
        `We have received your ${formType.toLowerCase()} (Reference: ${submission.reference_id || 'N/A'}).`,
        '',
        `---`,
        `Original Submission Details:`,
        `Name: ${submission.first_name} ${submission.last_name || ''}`,
        `Email: ${submission.email}`,
        submission.phone ? `Phone: ${submission.phone}` : '',
        submission.organization ? `Organization: ${submission.organization}` : '',
        submission.interest_type ? `Interest: ${submission.interest_type}` : '',
        `Submitted: ${new Date(submission.created_at).toLocaleString()}`,
        '',
        submission.message ? `Original Message:\n${submission.message}` : '',
        '',
        `---`,
        '',
        `Best regards,`,
        `Syntra Refining Team`,
        `info@syntrarefining.com`
      ].filter(line => line !== false);

      const body = encodeURIComponent(bodyLines.join('\n'));

      window.location.href = `mailto:${submission.email}?subject=${subject}&body=${body}`;
    }

    function addToCalendar(event) {
      event.preventDefault();

      const title = document.getElementById('eventTitle').value;
      const startDateTime = new Date(document.getElementById('eventStart').value);
      const endDateTime = new Date(document.getElementById('eventEnd').value);
      const description = document.getElementById('eventDescription').value;
      const attendee = document.getElementById('eventAttendee').value;

      const icsContent = generateICS(title, startDateTime, endDateTime, description, attendee);

      const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
      const link = document.createElement('a');
      link.href = window.URL.createObjectURL(blob);
      link.download = `syntra-followup-${Date.now()}.ics`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      closeCalendarModal();

      alert('Calendar event downloaded! Open the .ics file to add it to Microsoft Outlook or Office 365.');
    }

    function generateICS(title, startDate, endDate, description, attendee) {
      const formatICSDate = (date) => {
        return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
      };

      const icsContent = [
        'BEGIN:VCALENDAR',
        'VERSION:2.0',
        'PRODID:-//Syntra Refining//Form Follow-up//EN',
        'CALSCALE:GREGORIAN',
        'METHOD:REQUEST',
        'BEGIN:VEVENT',
        `DTSTART:${formatICSDate(startDate)}`,
        `DTEND:${formatICSDate(endDate)}`,
        `DTSTAMP:${formatICSDate(new Date())}`,
        `UID:${Date.now()}@syntrarefining.com`,
        `SUMMARY:${title}`,
        `DESCRIPTION:${description.replace(/\n/g, '\\n')}`,
        `LOCATION:Microsoft Teams / Office`,
        `STATUS:CONFIRMED`,
        `SEQUENCE:0`,
        `ORGANIZER;CN=Syntra Refining:mailto:support@syntrarefining.com`,
        attendee ? `ATTENDEE;CN=${attendee};RSVP=TRUE:mailto:${attendee}` : '',
        'BEGIN:VALARM',
        'TRIGGER:-PT15M',
        'ACTION:DISPLAY',
        'DESCRIPTION:Reminder',
        'END:VALARM',
        'END:VEVENT',
        'END:VCALENDAR'
      ].filter(line => line).join('\r\n');

      return icsContent;
    }

    checkAuth();
  </script>
  <script src="/js/syntra-contact-modal.js?v=203"></script>
</body>
</html>
